version: 2.1

jobs:
  build_and_push:
    docker:
      - image: cimg/node:20.0.0
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Build and Push to Docker Hub
          command: |
            echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
            docker build -t $DOCKER_USER/vite-frontend-app:latest .
            docker push $DOCKER_USER/vite-frontend-app:latest

  deploy:
    machine:
      image: ubuntu-2204:current
    steps:
      - run:
          name: Setup SSH Key and Deploy
          command: |
            # SSH directory banana
            mkdir -p ~/.ssh
            
            # FIX: printf use karne se key ka format (RSA Header/Footer) kharab nahi hota
            printf "%b" "$EC2_PRIVATE_KEY" > ~/.ssh/id_rsa
            
            # Permissions set karna
            chmod 600 ~/.ssh/id_rsa
            
            # EC2 ko known hosts mein add karna
            ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

            # SSH connection aur deployment
            ssh -i ~/.ssh/id_rsa $EC2_USER@$EC2_HOST \<< EOF
              # Docker Hub Login on EC2
              echo "$DOCKER_PASS" | sudo docker login -u "$DOCKER_USER" --password-stdin
              
              # Purana container cleanup
              sudo docker stop vite-app || true
              sudo docker rm vite-app || true
              
              # Nayi image pull aur run (Port 4040)
              sudo docker pull $DOCKER_USER/vite-frontend-app:latest
              sudo docker run -d --name vite-app -p 4040:4040 $DOCKER_USER/vite-frontend-app:latest
              
              # Cleanup unused images
              sudo docker image prune -f
            EOF

workflows:
  deploy-workflow:
    jobs:
      - build_and_push:
          filters:
            branches:
              only: main
      - deploy:
          requires:
            - build_and_push
          filters:
            branches:
              only: main